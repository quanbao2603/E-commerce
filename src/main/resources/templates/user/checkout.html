<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{user/layout}">

<head>
    <meta charset="UTF-8">
    <title>Thanh toán</title>
    <th:block layout:fragment="css">
        <link th:href="@{/css/user/checkout.css}" rel="stylesheet">
    </th:block>
</head>

<body>
<main layout:fragment="content" class="container py-4">

    <h3 class="mb-4 text-primary fw-bold">Thanh toán</h3>

    <div class="row g-4">
        <!-- Phần trái: Địa chỉ + phương thức thanh toán -->
        <div class="col-md-7">
            <div class="card shadow-sm border-0 rounded-3">
                <div class="card-body">
                    <h5 class="card-title mb-3 text-secondary">Thông tin nhận hàng</h5>

                    <div th:if="${defaultAddress != null}">
                        <p class="mb-1"><strong>Người nhận:</strong> <span th:text="${defaultAddress.fullname}"></span></p>
                        <p class="mb-1"><strong>Số điện thoại:</strong> <span th:text="${defaultAddress.phone}"></span></p>
                        <p class="mb-3"><strong>Địa chỉ:</strong> 
                            <span th:text="${defaultAddress.street} + ', ' + ${defaultAddress.ward} + ', ' + ${defaultAddress.district} + ', ' + ${defaultAddress.city}"></span>
                        </p>
                        <a th:href="@{/user/address}" class="text-decoration-none small text-primary">Thay đổi địa chỉ</a>
                    </div>

                    <div th:if="${defaultAddress == null}">
                        <p class="text-muted">Chưa có địa chỉ mặc định.</p>
                        <a th:href="@{/user/address}" class="btn btn-outline-primary btn-sm">Thêm địa chỉ</a>
                    </div>

                    <hr class="my-4">

                    <h5 class="card-title mb-3 text-secondary">Phương thức thanh toán</h5>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="cod" value="COD" checked>
                        <label class="form-check-label" for="cod">Thanh toán khi nhận hàng (COD)</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="bank" value="BANK">
                        <label class="form-check-label" for="bank">Chuyển khoản ngân hàng</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="momo" value="MOMO">
                        <label class="form-check-label" for="momo">Ví MoMo</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phần phải: Đơn hàng -->
        <div class="col-md-5">
            <div class="card shadow-sm border-0 rounded-3">
                <div class="card-body">
                    <h5 class="card-title mb-3 text-secondary">Đơn hàng của bạn</h5>

                    <div class="cart-items-container" style="max-height: 300px; overflow-y: auto;">
                        <div th:each="item : ${cart.items}" class="d-flex align-items-center mb-3 border-bottom pb-2">
                            <img th:src="@{${item.product.thumbnail}}" class="rounded" alt="Sản phẩm"
                                 style="width: 60px; height: 60px; object-fit: cover;">
                            <div class="ms-3 flex-grow-1">
                                <p class="mb-0 fw-semibold" th:text="${item.product.name}"></p>
                                <small class="text-muted">Số lượng: <span th:text="${item.quantity}"></span></small>
                            </div>
                            <div class="text-end">
                                <p class="mb-0 fw-bold text-primary"
                                   th:text="${#numbers.formatDecimal(item.itemTotal, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></p>
                            </div>
                        </div>
                    </div>

                    <hr class="my-3">

                    <div class="d-flex justify-content-between fw-semibold">
                        <span>Tổng cộng:</span>
                        <span class="text-danger fs-5"
                              th:text="${#numbers.formatDecimal(totalPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></span>
                    </div>

                    <form th:action="@{/checkout/confirm}" method="post" class="mt-4">
                        <input type="hidden" name="paymentMethod" id="selectedPayment">
                        <button type="submit" class="btn btn-primary w-100 rounded-pill py-2 fw-bold">
                            Đặt hàng
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

</main>

<script>
    // Gửi phương thức thanh toán được chọn vào form
    document.querySelector("form").addEventListener("submit", function (e) {
        const selected = document.querySelector("input[name='paymentMethod']:checked");
        document.getElementById("selectedPayment").value = selected.value;
    });
</script>

</body>
</html>
